semantic_models:
  # Primary Sales Hierarchy Model
  - name: sales_hierarchy
    description: "Sales hierarchy data representing organizational structure and reporting relationships"
    model: ref('stg_sf_sales_hierarchy')
    defaults:
      agg_time_dimension: effective_date
    
    entities:
      - name: hierarchy_id
        type: primary
        expr: hierarchy_id
        description: "Unique identifier for each hierarchy record"
      
      - name: parent_hierarchy_id
        type: foreign
        expr: parent_hierarchy_id
        description: "Reference to parent hierarchy record for self-referential joins"

      - name: employee_id
        type: unique
        expr: employee_id
        description: "Unique identifier for each employee"

    dimensions:
      - name: effective_date
        type: time
        expr: effective_date
        description: "Date when the hierarchy record becomes effective"
        type_params:
          time_granularity: day

      - name: end_date
        type: time
        expr: end_date
        description: "Date when the hierarchy record expires"
        type_params:
          time_granularity: day

      - name: level
        type: categorical
        expr: hierarchy_level
        description: "Level in the organization hierarchy"

      - name: department
        type: categorical
        expr: department_name
        description: "Department name"

      - name: region
        type: categorical
        expr: region_name
        description: "Geographic region"

    measures:
      - name: active_positions
        expr: hierarchy_id
        agg: count_distinct
        description: "Count of active positions"
        agg_time_dimension: effective_date

      - name: avg_team_size
        expr: team_size
        agg: average
        description: "Average team size"
        agg_time_dimension: effective_date

  # Opportunity Model
  - name: opportunity
    description: "Sales opportunities data"
    model: ref('stg_sf_opportunity')
    defaults:
      agg_time_dimension: created_date
    
    entities:
      - name: opportunity_id
        type: primary
        expr: opportunity_id
        description: "Unique identifier for each opportunity"
      
      - name: sales_hierarchy_created
        type: foreign
        expr: created_date_user_id_concat
        description: "Link to hierarchy based on created date"

      - name: sales_hierarchy_closed
        type: foreign
        expr: close_date_user_id_concat
        description: "Link to hierarchy based on close date"

      - name: sales_hierarchy_lost
        type: foreign
        expr: lost_date_user_id_concat
        description: "Link to hierarchy based on lost date"

      - name: sales_hierarchy_submitted
        type: foreign
        expr: submitted_date_user_id_concat
        description: "Link to hierarchy based on submitted date"

    dimensions:
      - name: created_date
        type: time
        expr: created_date
        description: "Date when the opportunity was created"
        type_params:
          time_granularity: day

      - name: close_date
        type: time
        expr: close_date
        description: "Date when the opportunity was closed"
        type_params:
          time_granularity: day

      - name: stage_name
        type: categorical
        expr: stage_name
        description: "Current stage of the opportunity"

      - name: is_won
        type: categorical
        expr: is_won
        description: "Whether the opportunity was won"

      - name: is_closed
        type: categorical
        expr: is_closed
        description: "Whether the opportunity is closed"

    measures:
      - name: total_amount
        expr: amount
        agg: sum
        description: "Total opportunity amount"
        agg_time_dimension: created_date

      - name: opportunity_count
        expr: opportunity_id
        agg: count_distinct
        description: "Count of opportunities"
        agg_time_dimension: created_date

      - name: win_rate
        expr: "CASE WHEN is_won THEN 1 ELSE 0 END"
        agg: average
        description: "Percentage of opportunities won"
        agg_time_dimension: created_date

  # Hierarchy Date Bridge Model
  - name: hierarchy_date_bridge
    description: "Bridge table for time-based hierarchy relationships"
    model: ref('hierarchy_date_bridge')
    defaults:
      agg_time_dimension: date_id
    
    entities:
      - name: hierarchy_date_key
        type: primary
        expr: hierarchy_date_key
        description: "Composite key of hierarchy_id and date"
      
      - name: hierarchy_id
        type: foreign
        expr: hierarchy_id
        description: "Reference to main hierarchy record"

    dimensions:
      - name: date_id
        type: time
        expr: date_id
        description: "Date dimension"
        type_params:
          time_granularity: day


metrics:
  - name: opp_amount
    description: "Total opportunity amount grouped by sales hierarchy"
    type: simple
    label: "Opportunity Amount"
    type_params:
      measure: total_amount